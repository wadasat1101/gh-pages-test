name: Fetch Stooq Data

on:
  schedule:
    - cron: '0 1 * * *'   # 毎日 日本時間10時（UTC+9）
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch & Convert Stooq Data (Daily / Weekly / Monthly)
        run: |
          python << 'EOF'
          import csv
          import json
          import time
          import subprocess
          import os

          # ===== 設定 =====
          SYMBOLS_FILE = 'symbols.json'
          OUTPUT_DIR = 'data'
          SLEEP_SEC = 2
          INTERVALS = {
              "daily": "d",
              "weekly": "w",
              "monthly": "m"
          }
          # =================

          with open(SYMBOLS_FILE, 'r', encoding='utf-8') as f:
              config = json.load(f)

          symbols = config['symbols']
          markets = config['markets']
          default_market = config.get('default', {}).get('market')

          for interval_name, interval_code in INTERVALS.items():
              interval_dir = f"{OUTPUT_DIR}/{interval_name}"
              os.makedirs(interval_dir, exist_ok=True)

              print(f"\n=== Processing {interval_name} data ===")

              for item in symbols:
                  code = item['code']
                  name = item.get('name', '')
                  market_key = item.get('market', default_market)
                  market = markets[market_key]

                  suffix = market.get('suffix', '')
                  has_volume = market.get('hasVolume', True)

                  symbol = f"{code}{suffix}"

                  csv_path = f"{interval_dir}/{code}.csv"
                  json_path = f"{interval_dir}/{code}.json"

                  url = f"https://stooq.pl/q/d/l/?s={symbol}&i={interval_code}"

                  print(f"Fetching {symbol} ({name}) [{interval_name}]")

                  subprocess.run(
                      ["curl", "-s", url, "-o", csv_path],
                      check=True
                  )

                  result = []

                  with open(csv_path, newline='', encoding='utf-8') as f:
                      reader = csv.DictReader(f)
                      for row in reader:
                          try:
                              record = {
                                  "time": row['Data'],
                                  "open": float(row['Otwarcie']),
                                  "high": float(row['Najwyzszy']),
                                  "low": float(row['Najnizszy']),
                                  "close": float(row['Zamkniecie'])
                              }

                              if has_volume and 'Wolumen' in row:
                                  record["volume"] = int(row['Wolumen'])

                              result.append(record)

                          except Exception:
                              continue

                  with open(json_path, 'w', encoding='utf-8') as f:
                      json.dump(result, f, indent=2, ensure_ascii=False)

                  print(f"Saved {json_path} ({len(result)} records)")

                  # Stooq 呼び出し制限対策
                  time.sleep(SLEEP_SEC)

          print("\nAll symbols & intervals processed successfully.")
          EOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/
          git commit -m "Update stock data (daily/weekly/monthly)" || echo "No changes"
          git push
