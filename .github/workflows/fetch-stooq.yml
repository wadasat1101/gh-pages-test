name: Fetch Stooq Data

on:
  schedule:
    - cron: '0 1 * * *'   # 毎日 日本時間10時（UTC+9）
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch & Convert Stooq Data (Daily / Weekly / Monthly)
        run: |
          python << 'EOF'
          import csv
          import json
          import time
          import subprocess
          import os

          # ===== 設定 =====
          SYMBOLS_FILE = 'symbols.json'
          OUTPUT_DIR = 'data'
          SLEEP_SEC = 2
          INTERVALS = {
              "daily": "d",
              "weekly": "w",
              "monthly": "m"
          }
          # =================

          with open(SYMBOLS_FILE, 'r', encoding='utf-8') as f:
              config = json.load(f)

          for market in config['markets']:
              market_code = market['market']
              suffix = market.get('suffix', '')

              print(f"=== Market: {market_code} ===")

              for interval_name, interval_code in INTERVALS.items():
                  interval_dir = f"{OUTPUT_DIR}/{market_code}/{interval_name}"
                  os.makedirs(interval_dir, exist_ok=True)

                  print(f"-- Interval: {interval_name}")

                  for sector in market['sectors']:
                      sector_name = sector['name']

                      for item in sector['symbols']:
                          code = item['code']
                          name = item.get('name', '')
                          stooq_symbol = item.get('stooq')

                          # Stooq用シンボル決定
                          symbol = stooq_symbol if stooq_symbol else f"{code}{suffix}"

                          csv_path = f"{interval_dir}/{code}.csv"
                          json_path = f"{interval_dir}/{code}.json"

                          url = f"https://stooq.pl/q/d/l/?s={symbol}&i={interval_code}"

                          print(f"Fetching {symbol} [{market_code}/{sector_name}/{interval_name}]")

                          subprocess.run(
                              ["curl", "-s", url, "-o", csv_path],
                              check=True
                          )

                          result = []

                          with open(csv_path, newline='', encoding='utf-8') as f:
                              reader = csv.DictReader(f)
                              for row in reader:
                                  try:
                                      result.append({
                                          "time": row['Data'],
                                          "open": float(row['Otwarcie']),
                                          "high": float(row['Najwyzszy']),
                                          "low": float(row['Najnizszy']),
                                          "close": float(row['Zamkniecie']),
                                          "volume": int(row['Wolumen'])
                                      })
                                  except Exception:
                                      continue

                          with open(json_path, 'w', encoding='utf-8') as f:
                              json.dump(result, f, indent=2, ensure_ascii=False)

                          print(f"Saved {json_path} ({len(result)} records)")

                          # 呼び出し制限対策
                          time.sleep(SLEEP_SEC)

          print("All markets / sectors / symbols / intervals processed.")
          EOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/
          git commit -m "Update stock data (JP & US / daily weekly monthly)" || echo "No changes"
          git push
