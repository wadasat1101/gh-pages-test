<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Stooq Stock Viewer</title>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 20px;
  }
  select, button {
    margin-right: 8px;
    padding: 4px 6px;
  }
  pre {
    margin-top: 16px;
    padding: 12px;
    background: #f5f5f5;
    max-height: 400px;
    overflow: auto;
  }
</style>
</head>
<body>

<h1>株価データビューア（Stooq）</h1>

<label>
  市場:
  <select id="marketSelect"></select>
</label>

<label>
  業種:
  <select id="sectorSelect"></select>
</label>

<label>
  銘柄:
  <select id="symbolSelect"></select>
</label>

<label>
  足種:
  <select id="intervalSelect">
    <option value="daily">日足</option>
    <option value="weekly">週足</option>
    <option value="monthly">月足</option>
  </select>
</label>

<button id="loadBtn">読み込み</button>

<pre id="output">(未読み込み)</pre>

<script>
let symbolsConfig;

const marketSelect  = document.getElementById('marketSelect');
const sectorSelect  = document.getElementById('sectorSelect');
const symbolSelect  = document.getElementById('symbolSelect');
const intervalSelect = document.getElementById('intervalSelect');
const output = document.getElementById('output');

/* ---------- 初期ロード ---------- */
fetch('symbols.json')
  .then(r => r.json())
  .then(json => {
    symbolsConfig = json;
    initMarkets();
  });

/* ---------- 市場 ---------- */
function initMarkets() {
  marketSelect.innerHTML = '';
  symbolsConfig.markets.forEach((m, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = m.name;
    marketSelect.appendChild(opt);
  });
  marketSelect.onchange = initSectors;
  initSectors();
}

/* ---------- 業種 ---------- */
function initSectors() {
  sectorSelect.innerHTML = '';
  symbolSelect.innerHTML = '';

  const market = symbolsConfig.markets[marketSelect.value];
  market.sectors.forEach((s, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = s.name;
    sectorSelect.appendChild(opt);
  });

  sectorSelect.onchange = initSymbols;
  initSymbols();
}

/* ---------- 銘柄 ---------- */
function initSymbols() {
  symbolSelect.innerHTML = '';

  const market = symbolsConfig.markets[marketSelect.value];
  const sector = market.sectors[sectorSelect.value];

  sector.symbols.forEach(sym => {
    const opt = document.createElement('option');
    opt.value = sym.code;
    opt.textContent = `${sym.code} ${sym.name}`;
    symbolSelect.appendChild(opt);
  });
}

/* ---------- データ読み込み ---------- */
document.getElementById('loadBtn').onclick = () => {
  const marketObj = symbolsConfig.markets[marketSelect.value];
  const market = marketObj.market;
  const code = symbolSelect.value;
  const interval = intervalSelect.value;

  const path = `data/${market}/${interval}/${code}.json`;

  fetch(path)
    .then(r => {
      if (!r.ok) throw new Error('データが存在しません');
      return r.json();
    })
    .then(json => {
      // 直近20件だけ表示
      output.textContent = JSON.stringify(json.slice(-20), null, 2);
    })
    .catch(err => {
      output.textContent = err.message;
    });
};
</script>

</body>
</html>
