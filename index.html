<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Stooq Stock Chart</title>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 20px;
  }
  select, button {
    margin-right: 8px;
    padding: 4px 6px;
  }
  #chart {
    margin-top: 20px;
    height: 500px;
  }
</style>
</head>
<body>

<h1>株価チャート（Stooq）</h1>

<label>市場:
  <select id="marketSelect"></select>
</label>

<label>業種:
  <select id="sectorSelect"></select>
</label>

<label>銘柄:
  <select id="symbolSelect"></select>
</label>

<label>足種:
  <select id="intervalSelect">
    <option value="daily">日足</option>
    <option value="weekly">週足</option>
    <option value="monthly">月足</option>
  </select>
</label>

<button id="loadBtn">表示</button>

<div id="chart"></div>

<script>
let symbolsConfig;
let chart, candleSeries, volumeSeries, maSeries;

/* ===== symbols.json 読み込み ===== */
fetch('symbols.json')
  .then(r => r.json())
  .then(json => {
    symbolsConfig = json;
    initMarkets();
  });

/* ===== プルダウン制御 ===== */
const marketSelect = document.getElementById('marketSelect');
const sectorSelect = document.getElementById('sectorSelect');
const symbolSelect = document.getElementById('symbolSelect');

function initMarkets() {
  marketSelect.innerHTML = '';
  symbolsConfig.markets.forEach((m, i) => {
    marketSelect.add(new Option(m.name, i));
  });
  marketSelect.onchange = initSectors;
  initSectors();
}

function initSectors() {
  sectorSelect.innerHTML = '';
  const market = symbolsConfig.markets[marketSelect.value];
  market.sectors.forEach((s, i) => {
    sectorSelect.add(new Option(s.name, i));
  });
  sectorSelect.onchange = initSymbols;
  initSymbols();
}

function initSymbols() {
  symbolSelect.innerHTML = '';
  const market = symbolsConfig.markets[marketSelect.value];
  const sector = market.sectors[sectorSelect.value];
  sector.symbols.forEach(s => {
    symbolSelect.add(new Option(`${s.code} ${s.name}`, s.code));
  });
}

/* ===== チャート初期化 ===== */
function initChart() {
  if (chart) chart.remove();

  chart = LightweightCharts.createChart(document.getElementById('chart'), {
    layout: { background: { color: '#ffffff' }, textColor: '#000' },
    rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.3 } },
    timeScale: { timeVisible: true, secondsVisible: false },
    width: document.getElementById('chart').clientWidth,
    height: 500
  });

  candleSeries = chart.addCandlestickSeries();
  volumeSeries = chart.addHistogramSeries({
    priceFormat: { type: 'volume' },
    priceScaleId: '',
    scaleMargins: { top: 0.7, bottom: 0 }
  });

  maSeries = chart.addLineSeries({
    color: 'blue',
    lineWidth: 2
  });
}

/* ===== 移動平均 ===== */
function calcMA(data, period = 25) {
  const ma = [];
  for (let i = period - 1; i < data.length; i++) {
    const slice = data.slice(i - period + 1, i + 1);
    const avg = slice.reduce((s, d) => s + d.close, 0) / period;
    ma.push({ time: data[i].time, value: avg });
  }
  return ma;
}

/* ===== データロード ===== */
document.getElementById('loadBtn').onclick = () => {
  const market = symbolsConfig.markets[marketSelect.value].market;
  const code = symbolSelect.value;
  const interval = document.getElementById('intervalSelect').value;

  const path = `data/${market}/${interval}/${code}.json`;

  fetch(path)
    .then(r => r.json())
    .then(data => {
      initChart();

      const candles = data.map(d => ({
        time: d.time,
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close
      }));

      const volumes = data.map(d => ({
        time: d.time,
        value: d.volume,
        color: d.close >= d.open ? '#26a69a' : '#ef5350'
      }));

      candleSeries.setData(candles);
      volumeSeries.setData(volumes);
      maSeries.setData(calcMA(candles, 25));

      chart.timeScale().fitContent();
    })
    .catch(e => alert('データ読み込み失敗'));
};
</script>

</body>
</html>
