<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8" />
	<title>株価チャート(branch1)</title>
	<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
	<style>
		body {
			margin: 0;
			font-family: system-ui, sans-serif;
			background: #111;
			color: #ddd;
			display: flex;
			flex-direction: column;
			height: 100vh;
			overflow: hidden
		}

		#toolbar {
			padding: 8px;
			display: flex;
			gap: 8px;
			background: #1a1a1a;
			align-items: center
		}

		.info-bar {
			padding: 6px 12px;
			font-size: 13px;
			background: #181818;
			border-bottom: 1px solid #222
		}

		#main {
			flex: 1;
			display: flex;
			overflow: hidden
		}

		#chart {
			flex: 3
		}

		#simPanel {
			flex: 1;
			background: #151515;
			border-left: 1px solid #333;
			padding: 12px;
			overflow: auto
		}

		.sim-group {
			margin-bottom: 12px
		}

		.sim-group label {
			font-size: 12px;
			color: #aaa;
			display: block
		}

		.sim-group input {
			width: 100%;
			padding: 6px;
			background: #222;
			color: #ddd;
			border: none;
			border-radius: 4px
		}

		#runSim {
			width: 100%;
			padding: 8px;
			background: #4caf50;
			border: none;
			border-radius: 4px;
			margin-top: 8px;
			cursor: pointer
		}

		#result {
			margin-top: 12px;
			font-size: 13px
		}

		.log {
			font-family: monospace;
			font-size: 12px;
			padding: 2px
		}

		.buy {
			color: #4caf50
		}

		.sell {
			color: #ff9800
		}

		select,
		button {
			background: #333;
			color: #ddd;
			border: none;
			padding: 6px 12px;
			border-radius: 4px
		}

		button.active {
			background: #4caf50;
			color: #000
		}

		#tooltip {
			position: absolute;
			display: none;
			pointer-events: none;
			background: rgba(0, 0, 0, .85);
			border: 1px solid #444;
			padding: 8px;
			font-size: 12px;
			color: #ddd;
			border-radius: 6px;
			white-space: nowrap;
			z-index: 1000
		}
		
		/* ===== TAB UI ===== */
		.tab-bar{
			display:flex;
			gap:4px;
			margin-bottom:8px;
		}

		.tab-btn{
			flex:1;
			padding:6px;
			cursor:pointer;
			background:#222;
			border-radius:4px;
			text-align:center;
		}

		.tab-btn.active{
			background:#4caf50;
			color:#000;
		}

		.tab-content{
			display:none;
		}

		.tab-content.active{
			display:block;
		}

	</style>
</head>

<body>

	<div id="toolbar">
		<select id="marketSelect"></select>
		<select id="sectorSelect"></select>
		<select id="symbolSelect"></select>
		<button data-interval="daily" class="active">日足</button>
		<button data-interval="weekly">週足</button>
		<button data-interval="monthly">月足</button>
	</div>

	<div class="info-bar">
		<span id="dateLabel">----</span>｜ 始値:
		<span id="openLabel">-</span> 高値:
		<span id="highLabel">-</span> 安値:
		<span id="lowLabel">-</span> 終値:
		<span id="closeLabel">-</span> 出来高:
		<span id="volumeLabel">-</span>
	</div>

	<div class="info-bar">
		<span id="maLegend"></span>
	</div>

	<div id="main">
		<div id="chart"></div>
		<div id="simPanel">
			<!-- ===== タブ切り替え ===== -->
			<div class="tab-bar">
				<div class="tab-btn active" data-tab="simTab">売買シミュ</div>
				<div class="tab-btn" data-tab="signalTab">シグナル</div>
			</div>
			<!-- ===== シミュ ===== -->
			<div id="simTab" class="tab-content active">
				<h3>売買シミュレーション</h3>
				<div class="sim-group">
					<label>購入条件（36MA乖離率 ≤ %）</label>
					<input id="buyDev" value="-30">
				</div>
				<div class="sim-group">
					<label>購入金額（円）</label>
					<input id="buyAmount" value="10000">
				</div>
				<div class="sim-group">
					<label>売却条件（36MA乖離率 ≥ %）</label>
					<input id="sellDev" value="30">
				</div>
				<button id="runSim">シミュレーション開始</button>
				<button id="clearSim">クリア</button>
				<div id="result"></div>
			</div>
			<!-- ===== シグナル ===== -->
			<div id="signalTab" class="tab-content">
				<h3>シグナル銘柄</h3>
				<div id="signalPanel">
					<div>
						<b style="color:#4caf50">買い</b>
						<div id="buyList"></div>
					</div>
					<div style="margin-top:10px">
						<b style="color:#ff9800">売り</b>
						<div id="sellList"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="tooltip"></div>

	<script>
		const MA_CONFIG = [{
				period: 12,
				color: "#e91e63"
			},
			{
				period: 24,
				color: "#03a9f4"
			},
			{
				period: 36,
				color: "#ff9800"
			}
		];

		const $ = id => document.getElementById(id);
		const isValid = v => v !== "-" && v !== undefined && v !== null;
		const formatDev = d => ({
			text: (d >= 0 ? "+" : "") + d.toFixed(1) + "%",
			color: d >= 0 ? "#4caf50" : "#ef5350"
		});

		const UI = {
			date: $("dateLabel"),
			open: $("openLabel"),
			high: $("highLabel"),
			low: $("lowLabel"),
			close: $("closeLabel"),
			volume: $("volumeLabel"),
			tooltip: $("tooltip"),
			legend: $("maLegend"),
			market: $("marketSelect"),
			sector: $("sectorSelect"),
			symbol: $("symbolSelect"),
			result: $("result"),
			maVals: [],
			maDevs: []
		};

		MA_CONFIG.forEach((m, i) => {
			UI.legend.insertAdjacentHTML(
				"beforeend",
				`<span style="color:${m.color}">■MA(${m.period})</span>:<span id="ma${i+1}Val">-</span>(<span id="ma${i+1}Dev">-</span>) `
			);
			UI.maVals.push($(`ma${i+1}Val`));
			UI.maDevs.push($(`ma${i+1}Dev`));
		});

		const STATE = {
			config: null,
			market: null,
			sector: null,
			symbol: null,
			interval: "daily",
			rawData: null,
			tradeLines: [],
			signals: {
				buy:[],
				sell:[]
			}
		};

		const chart = LightweightCharts.createChart($("chart"), {
			layout: {
				background: {
					color: "#111"
				},
				textColor: "#ddd"
			},
			grid: {
				vertLines: {
					color: "#222"
				},
				horzLines: {
					color: "#222"
				}
			},
			rightPriceScale: {
				scaleMargins: {
					top: .1,
					bottom: .3
				}
			},
			timeScale: {
				timeVisible: true
			},
			crosshair: {
				mode: LightweightCharts.CrosshairMode.Normal
			}
		});

		let candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
			upColor: "#4caf50",
			downColor: "#ef5350",
			borderUpColor: "#4caf50",
			borderDownColor: "#ef5350",
			wickUpColor: "#4caf50",
			wickDownColor: "#ef5350"
		});

		const volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
			priceFormat: {
				type: "volume"
			},
			priceScaleId: ""
		});
		volumeSeries.priceScale().applyOptions({
			scaleMargins: {
				top: .75,
				bottom: 0
			}
		});

		const maSeries = MA_CONFIG.map(cfg => chart.addSeries(
			LightweightCharts.LineSeries, {
				color: cfg.color,
				lineWidth: 1,
				lastValueVisible: false,
				priceLineVisible: false
			}));

		const buildMALine = (data, p) =>
			data.filter(d => isValid(d["ma" + p]))
			.map(d => ({
				time: d.time,
				value: d["ma" + p]
			}));

		function clearSim() {
			STATE.tradeLines.forEach(l => candleSeries.removePriceLine(l));
			STATE.tradeLines.length = 0;
		}

		function updateHeader(row) {
			UI.date.textContent = row.time;
			UI.open.textContent = row.open;
			UI.high.textContent = row.high;
			UI.low.textContent = row.low;
			UI.close.textContent = row.close;
			UI.volume.textContent = row.volume.toLocaleString();

			MA_CONFIG.forEach((cfg, i) => {
				const v = row["ma" + cfg.period];
				const d = row["dev" + cfg.period];
				if (isValid(v) && isValid(d)) {
					const f = formatDev(d);
					UI.maVals[i].textContent = v;
					UI.maDevs[i].textContent = f.text;
					UI.maDevs[i].style.color = f.color;
				} else {
					UI.maVals[i].textContent = "-";
					UI.maDevs[i].textContent = "-";
				}
			});
		}

		chart.subscribeCrosshairMove(param => {
			if (!param?.time || !param?.point) {
				UI.tooltip.style.display = "none";
				return;
			}
			const row = STATE.rawData.find(d => d.time === param.time);
			if (!row) return;

			updateHeader(row);

			let html = `<div><strong>${row.time}</strong></div>
<div>始値:${row.open}</div>
<div>高値:${row.high}</div>
<div>安値:${row.low}</div>
<div>終値:${row.close}</div>
<div>出来高:${row.volume.toLocaleString()}</div>`;

			MA_CONFIG.forEach(cfg => {
				const v = row["ma" + cfg.period];
				const d = row["dev" + cfg.period];
				if (isValid(v) && isValid(d)) {
					const f = formatDev(d);
					html += `<div>MA${cfg.period}:${v}
(<span style="color:${f.color}">${f.text}</span>)</div>`;
				}
			});

			UI.tooltip.innerHTML = html;
			const rect = $("chart").getBoundingClientRect();
			UI.tooltip.style.left = rect.left + param.point.x + 15 + "px";
			UI.tooltip.style.top = rect.top + param.point.y + 15 + "px";
			UI.tooltip.style.display = "block";
		});

		async function loadChart() {
			if (!STATE.symbol) return;

			clearSim();
			UI.result.innerHTML = "";

			const data = await (await fetch(
				`./data/${STATE.market}/${STATE.interval}/${STATE.symbol}.json`
			)).json();

			STATE.rawData = data;

			candleSeries.setData(data);
			volumeSeries.setData(data.map(d => ({
				time: d.time,
				value: d.volume || 0,
				color: d.close >= d.open ? "#4caf50aa" : "#ef5350aa"
			})));

			MA_CONFIG.forEach((cfg, i) =>
				maSeries[i].setData(buildMALine(data, cfg.period)));

			if (data.length > 150) {
				chart.timeScale().setVisibleRange({
					from: data.at(-150).time,
					to: data.at(-1).time
				});
			}

			updateHeader(data.at(-1));
		}

		$("runSim").onclick = () => {
			clearSim();

			const buyDev = parseFloat($("buyDev").value);
			const sellDev = parseFloat($("sellDev").value);
			const amount = parseFloat($("buyAmount").value);

			let qty = 0,
				cost = 0;
			let realized = 0;
			let logs = [];

			for (const row of STATE.rawData) {
				const dev = row.dev36;
				if (!isValid(dev)) continue;

				const price = row.close;

				if (dev <= buyDev) {
					const buyQty = Math.floor(amount / price);
					if (buyQty > 0) {
						qty += buyQty;
						cost += buyQty * price;

						logs.push(`<div class="log buy">
BUY ${row.time} @${price} x${buyQty}
乖離:${dev.toFixed(1)}% 保有:${qty}
</div>`);

						STATE.tradeLines.push(
							candleSeries.createPriceLine({
								price,
								color: "#4caf50",
								lineWidth: 1,
								lineStyle: 2,
								axisLabelVisible: true,
								title: "BUY"
							}));
					}
				} else if (qty > 0 && dev >= sellDev) {
					const avg = cost / qty;
					const pnl = (price - avg) * qty;
					realized += pnl;

					logs.push(`<div class="log sell">
SELL ${row.time} @${price}
株数:${qty} 損益:${pnl.toFixed(0)}
乖離:${dev.toFixed(1)}%
</div>`);

					STATE.tradeLines.push(
						candleSeries.createPriceLine({
							price,
							color: "#ff9800",
							lineWidth: 1,
							lineStyle: 2,
							axisLabelVisible: true,
							title: "SELL"
						}));

					qty = 0;
					cost = 0;
				}
			}

			let unrealized = 0;
			if (qty > 0) {
				const last = STATE.rawData.at(-1).close;
				unrealized = (last - (cost / qty)) * qty;
			}

			const total = realized + unrealized;

			UI.result.innerHTML =
				`<b>実現損益: ${realized.toFixed(0)} 円</b><br>
<b>評価損益: ${unrealized.toFixed(0)} 円</b><br>
<b>総損益: ${total.toFixed(0)} 円</b>
<hr>` + logs.join("");
		};

		$("clearSim").onclick = () => {
			clearSim();
			UI.result.innerHTML =``;
		};

		function populateMarkets() {
			UI.market.innerHTML = "";
			STATE.config.markets.forEach(m =>
				UI.market.appendChild(new Option(m.name, m.market)));
			STATE.market = STATE.config.markets[0].market;
			populateSectors();
		}
		
		function populateSectors(preserve=false) {

			const m = STATE.config.markets.find(x => x.market === STATE.market);

			UI.sector.innerHTML = "";

			m.sectors.forEach(s =>
				UI.sector.appendChild(new Option(s.name, s.code))
			);

			if(!preserve || !m.sectors.some(s=>s.code===STATE.sector)){
				STATE.sector = m.sectors[0].code;
			}

			UI.sector.value = STATE.sector;

			populateSymbols(preserve);
		}
		
		function populateSymbols(preserve=false) {

			const m = STATE.config.markets.find(x => x.market === STATE.market);
			const s = m.sectors.find(x => x.code === STATE.sector);

			UI.symbol.innerHTML = "";

			s.symbols.forEach(sym =>
				UI.symbol.appendChild(
					new Option(`${sym.code} ${sym.name}`, sym.code)
				)
			);

			if(!preserve || !s.symbols.some(sym=>sym.code===STATE.symbol)){
				STATE.symbol = s.symbols[0].code;
			}

			UI.symbol.value = STATE.symbol;

			loadChart();
		}
		
		function renderSignalLists() {

			const buyDiv = $("buyList");
			const sellDiv = $("sellList");

			buyDiv.innerHTML = "";
			sellDiv.innerHTML = "";

			const makeRow = s => {

				const el = document.createElement("div");

				el.style.cursor="pointer";
				el.style.fontSize="12px";
				el.style.padding="2px";

				el.textContent =
					`${s.symbol} (${s.timeframe}) ${s.dev36.toFixed(1)}%`;

				el.onclick = () => {

					STATE.market = s.market;
					STATE.interval = s.timeframe;
					STATE.symbol = s.symbol;

					// sector逆引き
					const marketObj = STATE.config.markets.find(m=>m.market===s.market);

					for(const sec of marketObj.sectors){
						if(sec.symbols.some(sym=>sym.code===s.symbol)){
							STATE.sector = sec.code;
							break;
						}
					}

					// UI同期
					UI.market.value = STATE.market;

					populateSectors(true);   // ← preserveモード

					// interval同期
					document.querySelectorAll("button[data-interval]")
						.forEach(b=>{
							b.classList.toggle(
								"active",
								b.dataset.interval === s.timeframe
							)
						});
				};
				return el;
			};

			STATE.signals.buy.forEach(s =>
				buyDiv.appendChild(makeRow(s)));

			STATE.signals.sell.forEach(s =>
				sellDiv.appendChild(makeRow(s)));
		}

		UI.market.onchange = e => {
			STATE.market = e.target.value;
			populateSectors();
		};
		UI.sector.onchange = e => {
			STATE.sector = e.target.value;
			populateSymbols();
		};
		UI.symbol.onchange = e => {
			STATE.symbol = e.target.value;
			loadChart();
		};

		document.querySelectorAll("button[data-interval]")
			.forEach(btn => {
				btn.onclick = () => {
					document.querySelectorAll("button[data-interval]")
						.forEach(b => b.classList.remove("active"));
					btn.classList.add("active");
					STATE.interval = btn.dataset.interval;
					loadChart();
				};
			});
		
		Promise.all([
			fetch("./symbols1.json").then(r => r.json()),
			fetch("./symbols2.json").then(r => r.json()),
		])
		.then((configs) => {
			// configs は [cfg1, cfg2, cfg3] の配列
			const mergedMarketsMap = new Map();

			configs.forEach(cfg => {
				cfg.markets.forEach(m => {
					if (mergedMarketsMap.has(m.market)) {
						const existing = mergedMarketsMap.get(m.market);

						// sectorsをコードでマージ
						const sectorMap = new Map();
						existing.sectors.forEach(s => sectorMap.set(s.code, {...s}));
						m.sectors.forEach(s => {
							if (sectorMap.has(s.code)) {
								// symbols をマージ（code で重複排除）
								const existingSymbols = sectorMap.get(s.code).symbols || [];
								const symbolMap = new Map();
								existingSymbols.forEach(sym => symbolMap.set(sym.code, sym));
								s.symbols.forEach(sym => symbolMap.set(sym.code, sym));
								sectorMap.get(s.code).symbols = Array.from(symbolMap.values());
							} else {
								sectorMap.set(s.code, {...s});
							}
						});

						existing.sectors = Array.from(sectorMap.values());
					} else {
						mergedMarketsMap.set(m.market, {...m});
					}
				});
			});

			STATE.config = { markets: Array.from(mergedMarketsMap.values()) };
			populateMarkets();  // 1回だけ呼ぶ
		})
		.catch(err => console.error("JSON読み込みエラー:", err));
		
		async function loadSignals() {

			try {
				const [buy, sell] = await Promise.all([
					fetch("./signals/buySignals.json").then(r=>r.json()),
					fetch("./signals/sellSignals.json").then(r=>r.json())
				]);

				STATE.signals.buy = buy;
				STATE.signals.sell = sell;

				renderSignalLists();

			} catch(e) {
				console.log("signal load failed");
			}
		}
		
		document.querySelectorAll(".tab-btn").forEach(btn=>{
			btn.onclick = () => {

				document.querySelectorAll(".tab-btn")
					.forEach(b=>b.classList.remove("active"));

				document.querySelectorAll(".tab-content")
					.forEach(c=>c.classList.remove("active"));

				btn.classList.add("active");
				$(btn.dataset.tab).classList.add("active");
			};
		});
		
		loadSignals();
	</script>
</body>
</html>