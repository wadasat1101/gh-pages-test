<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ—¥æœ¬æ ªãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒ“ãƒ¥ãƒ¼ã‚¢</title>

  <!-- v4å›ºå®šï¼ˆé‡è¦ï¼‰ -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f5f5f5;
    }

    header {
      padding: 10px;
      background: #222;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    select {
      padding: 4px;
      font-size: 14px;
    }

    #status {
      font-size: 12px;
      opacity: 0.8;
    }

    #chart {
      height: calc(100vh - 50px);
    }
  </style>
</head>
<body>

<header>
  <div>ğŸ“ˆ æ—¥æœ¬æ ªãƒãƒ£ãƒ¼ãƒˆ</div>
  <select id="symbolSelect"></select>
  <div id="status"></div>
</header>

<div id="chart"></div>

<script>
  const chart = LightweightCharts.createChart(
    document.getElementById('chart'),
    {
      layout: {
        background: { color: '#ffffff' },
        textColor: '#333',
      },
      rightPriceScale: {
        scaleMargins: {
          top: 0.2,
          bottom: 0.3,
        },
      },
      timeScale: {
        timeVisible: true,
        secondsVisible: false,
      },
    }
  );

  const candleSeries = chart.addCandlestickSeries();

  const volumeSeries = chart.addHistogramSeries({
    priceFormat: { type: 'volume' },
    priceScaleId: '',
    scaleMargins: {
      top: 0.7,
      bottom: 0,
    },
  });

  const statusEl = document.getElementById('status');
  const selectEl = document.getElementById('symbolSelect');

  function setStatus(msg) {
    statusEl.textContent = msg;
    console.log(msg);
  }

  async function loadSymbols() {
    const res = await fetch('./symbols.json');
    const json = await res.json();

    for (const s of json.symbols) {
      const opt = document.createElement('option');
      opt.value = s.code;
      opt.textContent = `${s.code} ${s.name}`;
      selectEl.appendChild(opt);
    }
  }

  async function loadChart(code) {
    setStatus(`Loading ${code}...`);

    try {
      const res = await fetch(`./data/${code}.json`);
      if (!res.ok) throw new Error('HTTP error');

      const data = await res.json();

      if (!data.length) {
        throw new Error('No data');
      }

      candleSeries.setData(data);

      volumeSeries.setData(
        data.map(d => ({
          time: d.time,
          value: d.volume,
          color: d.close >= d.open
            ? 'rgba(0,150,136,0.8)'
            : 'rgba(244,67,54,0.8)',
        }))
      );

      chart.timeScale().fitContent();
      setStatus(`Loaded ${code} (${data.length} records)`);

    } catch (e) {
      setStatus(`âŒ Failed to load ${code}`);
      candleSeries.setData([]);
      volumeSeries.setData([]);
      console.error(e);
    }
  }

  selectEl.addEventListener('change', () => {
    loadChart(selectEl.value);
  });

  // åˆæœŸåŒ–
  (async () => {
    await loadSymbols();
    if (selectEl.options.length > 0) {
      selectEl.selectedIndex = 0;
      loadChart(selectEl.value);
    }
  })();
</script>

</body>
</html>
