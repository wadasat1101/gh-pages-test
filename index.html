<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>株価チャート(local)（Stooq）</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #111;
      color: #ddd;
      
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #toolbar {
      padding: 8px;
      display: flex;
      gap: 8px;
      background: #1a1a1a;
      align-items: center;
    }
    
    #ohlc {
      padding: 6px 12px;
      font-size: 13px;
      background:#181818;
      border-bottom:1px solid #222;
    }
    
    #legend {
      padding: 4px 12px;
      font-size: 12px;
      background: #141414;
      border-bottom: 1px solid #222;
    }

    #legend span {
      margin-right: 12px;
    }

    .legend-ma5 {
      color: #ff9800;
    }

    .legend-ma25 {
      color: #03a9f4;
    }

    .legend-ma75 {
      color: #e91e63;
    }

    
    select, button {
      background: #333;
      color: #ddd;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
    }

    button.active {
      background: #4caf50;
      color: #000;
    }

    #chart {
      flex: 1;
    }
  </style>
</head>
<body>

<div id="toolbar">
  <select id="marketSelect"></select>
  <select id="sectorSelect"></select>
  <select id="symbolSelect"></select>

  <button data-interval="daily" class="active">日足</button>
  <button data-interval="weekly">週足</button>
  <button data-interval="monthly">月足</button>
</div>

<div id="ohlc">
  <span id="ohlc-date">----</span>
  ｜ 始値: <span id="ohlc-open">-</span>
  高値: <span id="ohlc-high">-</span>
  安値: <span id="ohlc-low">-</span>
  終値: <span id="ohlc-close">-</span>
  出来高: <span id="ohlc-volume">-</span>
</div>

<div id="legend">
  <span class="legend-ma5">■ 移動平均線(5)</span>
  <span class="legend-ma25">■ 移動平均線(25)</span>
  <span class="legend-ma75">■ 移動平均線(75)</span>
</div>


<div id="chart"></div>

<script>
  let config;
  let currentMarket;
  let currentSector;
  let currentSymbol;
  let currentInterval = 'daily';
  
  const ohlcDate  = document.getElementById('ohlc-date');
  const ohlcOpen  = document.getElementById('ohlc-open');
  const ohlcHigh  = document.getElementById('ohlc-high');
  const ohlcLow   = document.getElementById('ohlc-low');
  const ohlcClose = document.getElementById('ohlc-close');
  const ohlcVolume = document.getElementById('ohlc-volume');


  /* ===== チャート初期化 ===== */
  const chart = LightweightCharts.createChart(
    document.getElementById('chart'),
    {
      layout: {
        background: { color: '#111' },
        textColor: '#ddd',
      },
      grid: {
        vertLines: { color: '#222' },
        horzLines: { color: '#222' },
      },
      rightPriceScale: {
        scaleMargins: { top: 0.1, bottom: 0.3 },
      },
      timeScale: { timeVisible: true },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
      },
    }
  );
  
  chart.subscribeCrosshairMove(param => {
    if (!param || !param.time) return;
    if (!param.seriesData) return;
    
    const candle = param.seriesData.get(candleSeries);
    const volume = param.seriesData.get(volumeSeries);
    if (!candle) return;
    if (!volume) return;

    ohlcDate.textContent  = param.time;
    ohlcOpen.textContent  = candle.open.toFixed(2);
    ohlcHigh.textContent  = candle.high.toFixed(2);
    ohlcLow.textContent   = candle.low.toFixed(2);
    ohlcClose.textContent = candle.close.toFixed(2);
    
    ohlcVolume.textContent = volume.value.toLocaleString();    
  });
  
  chart.subscribeClick(param => {
    // クリックしたときの処理
  });


  // ===== ローソク足 =====
  const candleSeries = chart.addSeries(
    LightweightCharts.CandlestickSeries,
    {
      upColor: '#4caf50',
      downColor: '#ef5350',
      borderUpColor: '#4caf50',
      borderDownColor: '#ef5350',
      wickUpColor: '#4caf50',
      wickDownColor: '#ef5350',
    }
  );

  // ===== 出来高 =====
  const volumeSeries = chart.addSeries(
    LightweightCharts.HistogramSeries,
    {
      priceFormat: { type: 'volume' },
      priceScaleId: '',
    }
  );

  volumeSeries.priceScale().applyOptions({
    scaleMargins: { top: 0.75, bottom: 0 },
  });

  // ===== 移動平均線 =====
  const ma5Series = chart.addSeries(
    LightweightCharts.LineSeries,
    {
      color: '#ff9800',
      lineWidth: 1,
      lastValueVisible: false,
      priceLineVisible: false
    }
  );

  const ma25Series = chart.addSeries(
    LightweightCharts.LineSeries,
    {
      color: '#03a9f4',
      lineWidth: 1,
      lastValueVisible: false,
      priceLineVisible: false
    }
  );

  const ma75Series = chart.addSeries(
    LightweightCharts.LineSeries,
    { 
      color: '#e91e63',
      lineWidth: 1,
      lastValueVisible: false,
      priceLineVisible: false
    }
  );


  function calcSMA(data, period) {
    const result = [];
    for (let i = period - 1; i < data.length; i++) {
      const slice = data.slice(i - period + 1, i + 1);
      const avg = slice.reduce((s, d) => s + d.close, 0) / period;
      result.push({ time: data[i].time, value: avg });
    }
    return result;
  }

  async function loadData() {
    if (!currentSymbol) return;

    const path = `./data/${currentMarket}/${currentInterval}/${currentSymbol}.json`;
    const res = await fetch(path);
    const data = await res.json();

    candleSeries.setData(data);

    volumeSeries.setData(
      data.map(d => ({
        time: d.time,
        value: d.volume,
        color: d.close >= d.open ? '#4caf50aa' : '#ef5350aa',
      }))
    );

    ma5Series.setData(calcSMA(data, 5));
    ma25Series.setData(calcSMA(data, 25));
    ma75Series.setData(calcSMA(data, 75));

	
    // ローソク足をN本表示
    let n = 150;
    if (data.length > n) {
      const from = data[data.length - n].time;
      const to   = data[data.length - 1].time;

      chart.timeScale().setVisibleRange({
        from,
        to,
      });
    }
    
    if (data.length > 0) {
      const last = data[data.length - 1];
      ohlcDate.textContent  = last.time;
      ohlcOpen.textContent  = last.open.toFixed(2);
      ohlcHigh.textContent  = last.high.toFixed(2);
      ohlcLow.textContent   = last.low.toFixed(2);
      ohlcClose.textContent = last.close.toFixed(2);
      ohlcVolume.textContent = last.volume.toLocaleString();
    }

  }

  /* ===== プルダウン制御 ===== */
  const marketSelect = document.getElementById('marketSelect');
  const sectorSelect = document.getElementById('sectorSelect');
  const symbolSelect = document.getElementById('symbolSelect');

  function refreshMarket() {
    marketSelect.innerHTML = '';
    config.markets.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.market;
      opt.textContent = m.name;
      marketSelect.appendChild(opt);
    });
    currentMarket = config.markets[0].market;
    marketSelect.value = currentMarket;
    refreshSector();
  }

  function refreshSector() {
    sectorSelect.innerHTML = '';
    const market = config.markets.find(m => m.market === currentMarket);

    market.sectors.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.code;
      opt.textContent = s.name;
      sectorSelect.appendChild(opt);
    });

    currentSector = market.sectors[0].code;
    sectorSelect.value = currentSector;
    refreshSymbol();
  }

  function refreshSymbol() {
    symbolSelect.innerHTML = '';
    const market = config.markets.find(m => m.market === currentMarket);
    const sector = market.sectors.find(s => s.code === currentSector);

    sector.symbols.forEach(sym => {
      const opt = document.createElement('option');
      opt.value = sym.code;
      opt.textContent = `${sym.code} ${sym.name}`;
      symbolSelect.appendChild(opt);
    });

    currentSymbol = sector.symbols[0].code;
    symbolSelect.value = currentSymbol;
    loadData();
  }

  marketSelect.addEventListener('change', () => {
    currentMarket = marketSelect.value;
    refreshSector();
  });

  sectorSelect.addEventListener('change', () => {
    currentSector = sectorSelect.value;
    refreshSymbol();
  });

  symbolSelect.addEventListener('change', () => {
    currentSymbol = symbolSelect.value;
    loadData();
  });

  document.querySelectorAll('button[data-interval]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button[data-interval]')
        .forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentInterval = btn.dataset.interval;
      loadData();
    });
  });

  /* ===== symbols.json 読み込み ===== */
  fetch('./symbols.json')
    .then(res => res.json())
    .then(json => {
      config = json;
      refreshMarket();
    });
</script>

</body>
</html>
