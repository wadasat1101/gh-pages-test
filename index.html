<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>株価チャート（Stooq）</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #111;
      color: #ddd;
    }

    #toolbar {
      padding: 8px;
      display: flex;
      gap: 8px;
      background: #1a1a1a;
      align-items: center;
    }

    select, button {
      background: #333;
      color: #ddd;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
    }

    button.active {
      background: #4caf50;
      color: #000;
    }

    #chart {
      height: calc(100vh - 44px);
    }
  </style>
</head>
<body>

<div id="toolbar">
  <select id="symbolSelect"></select>

  <button data-interval="daily" class="active">日足</button>
  <button data-interval="weekly">週足</button>
  <button data-interval="monthly">月足</button>
</div>

<div id="chart"></div>

<script>
  let currentSymbol = null;
  let currentInterval = 'daily';

  const chart = LightweightCharts.createChart(
    document.getElementById('chart'),
    {
      layout: {
        background: { color: '#111' },
        textColor: '#ddd',
      },
      grid: {
        vertLines: { color: '#222' },
        horzLines: { color: '#222' },
      },
      rightPriceScale: {
        scaleMargins: { top: 0.1, bottom: 0.3 },
      },
      timeScale: { timeVisible: true },
    }
  );

  const candleSeries = chart.addSeries(
    LightweightCharts.CandlestickSeries,
    {
      upColor: '#4caf50',
      downColor: '#ef5350',
      borderUpColor: '#4caf50',
      borderDownColor: '#ef5350',
      wickUpColor: '#4caf50',
      wickDownColor: '#ef5350',
    }
  );

  const volumeSeries = chart.addSeries(
    LightweightCharts.HistogramSeries,
    {
      priceFormat: { type: 'volume' },
      priceScaleId: '',
    }
  );

  volumeSeries.priceScale().applyOptions({
    scaleMargins: { top: 0.75, bottom: 0 },
  });
  
  // 移動平均線
  const ma5Series = chart.addSeries(
    LightweightCharts.LineSeries,
    { color: '#ff9800', lineWidth: 1 }
  );
  
  const ma25Series = chart.addSeries(
    LightweightCharts.LineSeries,
    { color: '#03a9f4', lineWidth: 1 }
  );
  
  const ma75Series = chart.addSeries(
    LightweightCharts.LineSeries,
    { color: '#e91e63', lineWidth: 1 }
  );
  
  function calcSMA(data, period) {
    const result = [];
    for (let i = 0; i < data.length; i++) {
      if (i < period - 1) continue;
  
      const slice = data.slice(i - period + 1, i + 1);
      const avg =
        slice.reduce((sum, d) => sum + d.close, 0) / period;
  
      result.push({
        time: data[i].time,
        value: avg,
      });
    }
    return result;
  }


  async function loadData() {
    if (!currentSymbol) return;
  
    const res = await fetch(`./data/${currentInterval}/${currentSymbol}.json`);
    const data = await res.json();
  
    candleSeries.setData(data);
  
    volumeSeries.setData(
      data.map(d => ({
        time: d.time,
        value: d.volume,
        color: d.close >= d.open ? '#4caf50aa' : '#ef5350aa',
      }))
    );
  
    // 移動平均線
    ma5Series.setData(calcSMA(data, 5));
    ma25Series.setData(calcSMA(data, 25));
    ma75Series.setData(calcSMA(data, 75));
  
    chart.timeScale().fitContent();
  }


  // symbols.json 読み込み
  fetch('./symbols.json')
    .then(res => res.json())
    .then(json => {
      const select = document.getElementById('symbolSelect');

      json.symbols.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.code;
        opt.textContent = `${s.code} ${s.name}`;
        select.appendChild(opt);
      });

      currentSymbol = json.symbols[0].code;
      loadData();

      select.addEventListener('change', () => {
        currentSymbol = select.value;
        loadData();
      });
    });

  // 足種別切替
  document.querySelectorAll('button[data-interval]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentInterval = btn.dataset.interval;
      loadData();
    });
  });
</script>

</body>
</html>
